name: Lint and test

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout â¬‡ï¸
        uses: actions/checkout@master
        with:
          persist-credentials: false
          submodules: recursive

      - name: Setup python ðŸ
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Prepare setup directory
        run: |
          mkdir -p .setups
          # Create a default setup file
          cat > .setups/githubtest.sh << 'EOF'
          export CF_CERN_USER="github"
          export CF_DATA="$CF_REPO_BASE/columnflow_venv"
          export CF_SOFTWARE_BASE="$CF_DATA/software"
          export CF_VENV_BASE="$CF_SOFTWARE_BASE/venvs"
          export CF_JOB_BASE="$CF_SOFTWARE_BASE/data/jobs"
          export CF_STORE_NAME="cf_store"
          export CF_STORE_LOCAL="$CF_REPO_BASE/data/$CF_STORE_NAME"
          export CF_WLCG_CACHE_ROOT=""
          export CF_VENV_SETUP_MODE_UPDATE="false"
          export CF_INTERACTIVE_VENV_FILE=""
          export CF_LOCAL_SCHEDULER="true"
          export CF_FLAVOR="cms"
          export CF_REMOTE_ENV="true"
          EOF

      - name: Install dependencies â˜•ï¸
        run: |
          which micromamba || echo "micromamba not found"
          micromamba --version || echo "Failed to get micromamba version"

          export CI="true"
          export GITHUB_ACTIONS="true"
          export CF_REMOTE_ENV="true"
          export CF_SETUP_NAME="github_actions"
          export CF_REPO_BASE=$PWD
          export CF_BASE="$CF_REPO_BASE/modules/columnflow"
          export CF_SOFTWARE_BASE="$CF_REPO_BASE/columnflow_venv/software"
          export CF_SKIP_SETUP="false"
          export CF_REPO_BASE_ALIAS="MULTILEPTON_BASE"
          export CF_LOCAL_ENV="true"

          which micromamba || echo "micromamba not found"
          micromamba --version || echo "Failed to get micromamba version"

          # Create micromamba.sh
          mkdir -p "$CF_SOFTWARE_BASE/conda/etc/profile.d"
          cat > "$CF_SOFTWARE_BASE/conda/etc/profile.d/micromamba.sh" << 'EOF'
          export MAMBA_ROOT_PREFIX="$CF_SOFTWARE_BASE/conda"
          export MAMBA_EXE="$MAMBA_ROOT_PREFIX/bin/micromamba"
          export PATH="$MAMBA_ROOT_PREFIX/bin:$PATH"
          EOF
 
          echo "Running full setup..."
          source setup.sh "githubtest"
 
          which micromamba
          micromamba --version 

      - name: Lint ðŸ”
        run: |
          source setup.sh "githubtest"
          ./tests/run_linting
