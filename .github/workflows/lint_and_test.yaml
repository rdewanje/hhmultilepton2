name: Lint and test

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout â¬‡ï¸
        uses: actions/checkout@master
        with:
          persist-credentials: false
          submodules: recursive

      - name: Setup python ğŸ
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Prepare setup directory
        run: |
          mkdir -p .setups
          # Create a default setup file
          cat > .setups/githubtest.sh << 'EOF'
          export CF_CERN_USER="github"
          export CF_DATA="$PWD/data"
          export CF_SOFTWARE_BASE="$PWD/columnflow_venv/software"
          export CF_JOB_BASE="$PWD/data/jobs"
          export CF_STORE_NAME="cf_store"
          export CF_STORE_LOCAL="$PWD/data/cf_store"
          export CF_WLCG_CACHE_ROOT=""
          export CF_VENV_SETUP_MODE_UPDATE="false"
          export CF_INTERACTIVE_VENV_FILE=""
          export CF_LOCAL_SCHEDULER="true"
          export CF_FLAVOR="cms"
          export CF_REMOTE_ENV="true"
          EOF

      - name: Install dependencies â˜•ï¸
        run: |
          export CI="true"
          export GITHUB_ACTIONS="true"
          export CF_REMOTE_ENV="true"
          export CF_BASE="$PWD/modules/columnflow"
          export CF_REPO_BASE="$PWD"
          export CF_SETUP_NAME="github_actions"
          export CF_SOFTWARE_BASE="$PWD/columnflow_venv/software"
          export CF_SKIP_SETUP="false"

          echo "Running full setup..."
          
          echo "=== Step 1: Run columnflow setup ==="
          source "$CF_BASE/setup.sh" "" || true
          
          echo "=== Step 2: Run main setup ==="
          source setup.sh "githubtest"
 
          which micromamba
          micromamba --version 

      - name: Lint ğŸ”
        run: |
          source setup.sh "githubtest"
          ./tests/run_linting
